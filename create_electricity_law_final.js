const mongoose = require('mongoose');
const LegalDocument = require('./models/LegalDocument');

// Connect to MongoDB
mongoose.connect('mongodb://localhost:27017/lawbot', {
  useNewUrlParser: true,
  useUnifiedTopology: true
});

async function createElectricityLawDocument() {
  try {
    console.log('=== ุฅูุดุงุก ูุซููุฉ ูุงููู ุงูููุฑุจุงุก ุงูุฃุฑุฏูู ===');
    
    // Delete all existing documents first
    await LegalDocument.deleteMany({});
    console.log('ุชู ุญุฐู ุฌููุน ุงููุซุงุฆู ุงูููุฌูุฏุฉ');
    
    // Create the electricity law document with proper structure
    const electricityLawDoc = new LegalDocument({
      title: 'Jordanian Electricity Law',
      titleArabic: 'ูุงููู ุงูููุฑุจุงุก ุงูุฃุฑุฏูู',
      type: 'regulation',
      category: 'Civil Law',
      officialNumber: 'LAW-13-2002',
      publicationDate: new Date('2002-01-01'),
      effectiveDate: new Date('2002-01-01'),
      summary: 'Jordanian Electricity Law No. (13) of 2002 - Regulates the electricity sector in Jordan',
      summaryArabic: 'ูุงููู ุงูููุฑุจุงุก ุงูุฃุฑุฏูู ุฑูู (13) ูุณูุฉ 2002 - ููุธู ูุทุงุน ุงูููุฑุจุงุก ูู ุงูุฃุฑุฏู',
      
      // Articles array with detailed content
      articles: [
        {
          number: '1',
          title: 'ุงูุชุณููุฉ ูุงูููุงุฐ',
          content: 'ูุณูู ูุฐุง ุงููุงููู (ูุงููู ุงูููุฑุจุงุก ูุณูุฉ 2002) ููุนูู ุจู ูู ุชุงุฑูุฎ ูุดุฑู ูู ุงูุฌุฑูุฏุฉ ุงูุฑุณููุฉ.',
          keywords: ['ุชุณููุฉ', 'ููุงุฐ', 'ูุงููู ุงูููุฑุจุงุก']
        },
        {
          number: '2',
          title: 'ุงูุชุนุฑููุงุช',
          content: 'ูููู ูููููุงุช ูุงูุนุจุงุฑุงุช ุงูุชุงููุฉ ุญูุซูุง ูุฑุฏุช ูู ูุฐุง ุงููุงููู ุงููุนุงูู ุงููุฎุตุตุฉ ููุง ุฃุฏูุงู ูุง ูู ุชุฏู ุงููุฑููุฉ ุนูู ุบูุฑ ุฐูู:\n\nุฃ- ุงููุฒุงุฑุฉ: ูุฒุงุฑุฉ ุงูุทุงูุฉ ูุงูุซุฑูุฉ ุงููุนุฏููุฉ\nุจ- ุงููุฒูุฑ: ูุฒูุฑ ุงูุทุงูุฉ ูุงูุซุฑูุฉ ุงููุนุฏููุฉ\nุฌ- ุงูููุฆุฉ: ููุฆุฉ ุชูุธูู ูุทุงุน ุงูุทุงูุฉ ูุงููุนุงุฏู\nุฏ- ุงูุฑุฆูุณ: ุฑุฆูุณ ูุฌูุณ ูููุถู ุงูููุฆุฉ\nู- ุงูุดุฑูุฉ ุงููุทููุฉ: ุงูุดุฑูุฉ ุงููุทููุฉ ููููุฑุจุงุก\nู- ุงููุฑุฎุต ูู: ุฃู ุดุฎุต ุทุจูุนู ุฃู ุงุนุชุจุงุฑู ุญุงุตู ุนูู ุชุฑุฎูุต ูู ุงูููุฆุฉ ูููุงุฑุณุฉ ุฃู ูู ุฃูุดุทุฉ ุงูููุฑุจุงุก\nุฒ- ุงูููุฑุจุงุก: ุงูุทุงูุฉ ุงูููุฑุจุงุฆูุฉ ุจุฌููุน ุฃุดูุงููุง ูุฃููุงุนูุง\nุญ- ุดุจูุฉ ุงูููู: ุงูุดุจูุฉ ุงูููุฑุจุงุฆูุฉ ุงููุฎุตุตุฉ ูููู ุงูููุฑุจุงุก ุจุฌูุฏ ุนุงูู\nุท- ุดุจูุฉ ุงูุชูุฒูุน: ุงูุดุจูุฉ ุงูููุฑุจุงุฆูุฉ ุงููุฎุตุตุฉ ูุชูุฒูุน ุงูููุฑุจุงุก ุจุฌูุฏ ูุชูุณุท ูููุฎูุถ\nู- ุงููุณุชููู: ุฃู ุดุฎุต ุทุจูุนู ุฃู ุงุนุชุจุงุฑู ูุณุชููู ุงูููุฑุจุงุก ูุฃุบุฑุงุถู ุงูุฎุงุตุฉ\nู- ุงูุชุนุฑูุฉ: ุงูุฃุณุนุงุฑ ูุงูุฑุณูู ุงููุญุฏุฏุฉ ูุฎุฏูุงุช ุงูููุฑุจุงุก',
          keywords: ['ุชุนุฑููุงุช', 'ูุฒุงุฑุฉ ุงูุทุงูุฉ', 'ููุฆุฉ ุงูุชูุธูู', 'ุงูููุฑุจุงุก', 'ุดุจูุฉ ุงูููู', 'ุดุจูุฉ ุงูุชูุฒูุน']
        },
        {
          number: '3',
          title: 'ุฃูุฏุงู ุงููุงููู',
          content: 'ููุฏู ูุฐุง ุงููุงููู ุฅูู ุชุญููู ูุง ููู:\nุฃ- ุชูุธูู ูุทุงุน ุงูููุฑุจุงุก ูุถูุงู ุชุทููุฑู ุจูุง ูุญูู ุงููุตูุญุฉ ุงูุนุงูุฉ\nุจ- ุถูุงู ุชูููุฑ ุฎุฏูุงุช ุงูููุฑุจุงุก ุจุฌูุฏุฉ ุนุงููุฉ ูุฃุณุนุงุฑ ูุนูููุฉ\nุฌ- ุชุดุฌูุน ุงูุงุณุชุซูุงุฑ ูู ูุทุงุน ุงูููุฑุจุงุก\nุฏ- ุญูุงูุฉ ุงููุณุชููููู ูุงูุจูุฆุฉ\nู- ุชุนุฒูุฒ ุงูููุงุกุฉ ูู ุงุณุชุฎุฏุงู ุงูุทุงูุฉ\nู- ุชุทููุฑ ูุตุงุฏุฑ ุงูุทุงูุฉ ุงููุชุฌุฏุฏุฉ',
          keywords: ['ุฃูุฏุงู', 'ุชูุธูู', 'ุฌูุฏุฉ', 'ุงุณุชุซูุงุฑ', 'ุญูุงูุฉ ุงููุณุชููููู', 'ุงูุจูุฆุฉ']
        },
        {
          number: '4',
          title: 'ุฅูุดุงุก ุงูููุฆุฉ',
          content: 'ุชูุดุฃ ุจููุฌุจ ุฃุญูุงู ูุฐุง ุงููุงููู ููุฆุฉ ูุณุชููุฉ ุชุณูู (ููุฆุฉ ุชูุธูู ูุทุงุน ุงูุทุงูุฉ ูุงููุนุงุฏู) ุชุชูุชุน ุจุงูุดุฎุตูุฉ ุงูุงุนุชุจุงุฑูุฉ ูุงูุงุณุชููุงู ุงููุงูู ูุงูุฅุฏุงุฑูุ ููููู ููุฑูุง ุงูุฑุฆูุณู ูู ุนูุงู.',
          keywords: ['ููุฆุฉ ุงูุชูุธูู', 'ุงุณุชููุงููุฉ', 'ุดุฎุตูุฉ ุงุนุชุจุงุฑูุฉ']
        }
      ],
      
      // Full text for search
      fullText: `ูุงููู ุงูููุฑุจุงุก ุงูุฃุฑุฏูู ุฑูู (13) ูุณูุฉ 2002\n\nุงููุงุฏุฉ 1: ุงูุชุณููุฉ ูุงูููุงุฐ\nูุณูู ูุฐุง ุงููุงููู (ูุงููู ุงูููุฑุจุงุก ูุณูุฉ 2002) ููุนูู ุจู ูู ุชุงุฑูุฎ ูุดุฑู ูู ุงูุฌุฑูุฏุฉ ุงูุฑุณููุฉ.\n\nุงููุงุฏุฉ 2: ุงูุชุนุฑููุงุช\nูููู ูููููุงุช ูุงูุนุจุงุฑุงุช ุงูุชุงููุฉ ุญูุซูุง ูุฑุฏุช ูู ูุฐุง ุงููุงููู ุงููุนุงูู ุงููุฎุตุตุฉ ููุง ุฃุฏูุงู ูุง ูู ุชุฏู ุงููุฑููุฉ ุนูู ุบูุฑ ุฐูู:\nุฃ- ุงููุฒุงุฑุฉ: ูุฒุงุฑุฉ ุงูุทุงูุฉ ูุงูุซุฑูุฉ ุงููุนุฏููุฉ\nุจ- ุงููุฒูุฑ: ูุฒูุฑ ุงูุทุงูุฉ ูุงูุซุฑูุฉ ุงููุนุฏููุฉ\nุฌ- ุงูููุฆุฉ: ููุฆุฉ ุชูุธูู ูุทุงุน ุงูุทุงูุฉ ูุงููุนุงุฏู\nุฏ- ุงูุฑุฆูุณ: ุฑุฆูุณ ูุฌูุณ ูููุถู ุงูููุฆุฉ\nู- ุงูุดุฑูุฉ ุงููุทููุฉ: ุงูุดุฑูุฉ ุงููุทููุฉ ููููุฑุจุงุก\nู- ุงููุฑุฎุต ูู: ุฃู ุดุฎุต ุทุจูุนู ุฃู ุงุนุชุจุงุฑู ุญุงุตู ุนูู ุชุฑุฎูุต ูู ุงูููุฆุฉ ูููุงุฑุณุฉ ุฃู ูู ุฃูุดุทุฉ ุงูููุฑุจุงุก\nุฒ- ุงูููุฑุจุงุก: ุงูุทุงูุฉ ุงูููุฑุจุงุฆูุฉ ุจุฌููุน ุฃุดูุงููุง ูุฃููุงุนูุง\nุญ- ุดุจูุฉ ุงูููู: ุงูุดุจูุฉ ุงูููุฑุจุงุฆูุฉ ุงููุฎุตุตุฉ ูููู ุงูููุฑุจุงุก ุจุฌูุฏ ุนุงูู\nุท- ุดุจูุฉ ุงูุชูุฒูุน: ุงูุดุจูุฉ ุงูููุฑุจุงุฆูุฉ ุงููุฎุตุตุฉ ูุชูุฒูุน ุงูููุฑุจุงุก ุจุฌูุฏ ูุชูุณุท ูููุฎูุถ\nู- ุงููุณุชููู: ุฃู ุดุฎุต ุทุจูุนู ุฃู ุงุนุชุจุงุฑู ูุณุชููู ุงูููุฑุจุงุก ูุฃุบุฑุงุถู ุงูุฎุงุตุฉ\nู- ุงูุชุนุฑูุฉ: ุงูุฃุณุนุงุฑ ูุงูุฑุณูู ุงููุญุฏุฏุฉ ูุฎุฏูุงุช ุงูููุฑุจุงุก\n\nุงููุงุฏุฉ 3: ุฃูุฏุงู ุงููุงููู\nููุฏู ูุฐุง ุงููุงููู ุฅูู ุชุญููู ูุง ููู:\nุฃ- ุชูุธูู ูุทุงุน ุงูููุฑุจุงุก ูุถูุงู ุชุทููุฑู ุจูุง ูุญูู ุงููุตูุญุฉ ุงูุนุงูุฉ\nุจ- ุถูุงู ุชูููุฑ ุฎุฏูุงุช ุงูููุฑุจุงุก ุจุฌูุฏุฉ ุนุงููุฉ ูุฃุณุนุงุฑ ูุนูููุฉ\nุฌ- ุชุดุฌูุน ุงูุงุณุชุซูุงุฑ ูู ูุทุงุน ุงูููุฑุจุงุก\nุฏ- ุญูุงูุฉ ุงููุณุชููููู ูุงูุจูุฆุฉ\nู- ุชุนุฒูุฒ ุงูููุงุกุฉ ูู ุงุณุชุฎุฏุงู ุงูุทุงูุฉ\nู- ุชุทููุฑ ูุตุงุฏุฑ ุงูุทุงูุฉ ุงููุชุฌุฏุฏุฉ\n\nุงููุงุฏุฉ 4: ุฅูุดุงุก ุงูููุฆุฉ\nุชูุดุฃ ุจููุฌุจ ุฃุญูุงู ูุฐุง ุงููุงููู ููุฆุฉ ูุณุชููุฉ ุชุณูู (ููุฆุฉ ุชูุธูู ูุทุงุน ุงูุทุงูุฉ ูุงููุนุงุฏู) ุชุชูุชุน ุจุงูุดุฎุตูุฉ ุงูุงุนุชุจุงุฑูุฉ ูุงูุงุณุชููุงู ุงููุงูู ูุงูุฅุฏุงุฑูุ ููููู ููุฑูุง ุงูุฑุฆูุณู ูู ุนูุงู.`,
      
      // Keywords for better search
      keywords: [
        { term: 'electricity', termArabic: 'ููุฑุจุงุก', weight: 1.0 },
        { term: 'energy', termArabic: 'ุทุงูุฉ', weight: 0.9 },
        { term: 'regulation', termArabic: 'ุชูุธูู', weight: 0.8 },
        { term: 'ministry', termArabic: 'ูุฒุงุฑุฉ', weight: 0.7 },
        { term: 'authority', termArabic: 'ููุฆุฉ', weight: 0.7 },
        { term: 'definitions', termArabic: 'ุชุนุฑููุงุช', weight: 0.6 }
      ],
      
      // Source information
      source: {
        officialGazette: {
          issue: '4475',
          date: new Date('2002-01-15'),
          page: 234
        },
        verified: true,
        verifiedBy: 'Legal System Administrator',
        verificationDate: new Date()
      },
      
      // Search index (will be auto-populated by pre-save middleware)
      searchIndex: {
        lastIndexed: new Date()
      }
    });
    
    // Save the document
    const savedDoc = await electricityLawDoc.save();
    console.log('โ ุชู ุฅูุดุงุก ูุซููุฉ ูุงููู ุงูููุฑุจุงุก ุจูุฌุงุญ!');
    console.log('ูุนุฑู ุงููุซููุฉ:', savedDoc._id);
    console.log('ุงูุนููุงู ุงูุนุฑุจู:', savedDoc.titleArabic);
    console.log('ุนุฏุฏ ุงูููุงุฏ:', savedDoc.articles.length);
    
    // Test searching for Article 2
    console.log('\n=== ุงุฎุชุจุงุฑ ุงูุจุญุซ ุนู ุงููุงุฏุฉ 2 ===');
    
    // Test 1: Direct article search
    const article2 = savedDoc.articles.find(article => article.number === '2');
    if (article2) {
      console.log('โ ุชู ุงูุนุซูุฑ ุนูู ุงููุงุฏุฉ 2:');
      console.log('ุงูุนููุงู:', article2.title);
      console.log('ุจุฏุงูุฉ ุงููุญุชูู:', article2.content.substring(0, 100) + '...');
    }
    
    // Test 2: Search using the same method as the chat system
    const searchQuery = 'ุงููุงุฏุฉ 2';
    const searchResults = await LegalDocument.find({
      status: 'active',
      $or: [
        { title: { $regex: searchQuery, $options: 'i' } },
        { titleArabic: { $regex: searchQuery, $options: 'i' } },
        { summary: { $regex: searchQuery, $options: 'i' } },
        { fullText: { $regex: searchQuery, $options: 'i' } },
        { 'articles.content': { $regex: searchQuery, $options: 'i' } }
      ]
    }).limit(5);
    
    console.log('\n=== ูุชุงุฆุฌ ุงูุจุญุซ ุจุงุณุชุฎุฏุงู ููุณ ุทุฑููุฉ ุงููุธุงู ===');
    console.log('ุนุฏุฏ ุงููุชุงุฆุฌ:', searchResults.length);
    
    if (searchResults.length > 0) {
      const doc = searchResults[0];
      console.log('ุงููุซููุฉ ุงูุฃููู:', doc.titleArabic);
      
      // Check if fullText contains Article 2
      if (doc.fullText && doc.fullText.includes('ุงููุงุฏุฉ 2')) {
        console.log('โ ุงููุต ุงููุงูู ูุญุชูู ุนูู ุงููุงุฏุฉ 2');
        
        // Extract Article 2 content
        const article2Match = doc.fullText.match(/ุงููุงุฏุฉ 2[^\n]*\n([\s\S]*?)(?=\n\nุงููุงุฏุฉ 3|$)/i);
        if (article2Match) {
          console.log('โ ุชู ุงุณุชุฎุฑุงุฌ ูุญุชูู ุงููุงุฏุฉ 2:');
          console.log(article2Match[0].substring(0, 200) + '...');
        }
      }
    }
    
    console.log('\n๐ ุชู ุฅูุดุงุก ุงููุซููุฉ ุจูุฌุงุญ! ูููู ุงูุขู ูููุธุงู ุงูุงุณุชุฌุงุจุฉ ูุทูุจุงุช ุงููุงุฏุฉ 2.');
    
  } catch (error) {
    console.error('ุฎุทุฃ ูู ุฅูุดุงุก ุงููุซููุฉ:', error.message);
    if (error.code === 11000) {
      console.error('ุฎุทุฃ: ุงูุฑูู ุงูุฑุณูู ููุฑุฑ. ุณุฃุญุงูู ุจุฑูู ูุฎุชูู...');
      // ูููู ุฅุนุงุฏุฉ ุงููุญุงููุฉ ุจุฑูู ูุฎุชูู ููุง
    }
  } finally {
    await mongoose.connection.close();
    console.log('ุชู ุฅุบูุงู ุงูุงุชุตุงู ุจูุงุนุฏุฉ ุงูุจูุงูุงุช');
  }
}

// ุชุดุบูู ุงูุฏุงูุฉ
createElectricityLawDocument();